{% extends "base.html" %}

{% block title %}Predictions - Oral Cancer Prediction System{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title">Unified Prediction Form</h1>
    <p class="page-subtitle">Enter patient information once, then select any model to predict</p>

    <div class="prediction-container">
        <!-- Model Selection Buttons -->
        <div class="model-selector">
            <h3>Select Prediction Model</h3>
            <div class="model-buttons">
                <button class="model-btn" data-model="cancer_label" id="btn-cancer_label">
                    <i class="fas fa-diagnoses"></i>
                    Cancer Label
                    <span class="status-indicator {{ 'status-healthy' if model_status.get('cancer_label') == 'HEALTHY' else 'status-offline' }}"></span>
                </button>
                <button class="model-btn" data-model="cost" id="btn-cost">
                    <i class="fas fa-dollar-sign"></i>
                    Treatment Cost
                    <span class="status-indicator {{ 'status-healthy' if model_status.get('cost') == 'HEALTHY' else 'status-offline' }}"></span>
                </button>
                <button class="model-btn" data-model="survival_rate" id="btn-survival_rate">
                    <i class="fas fa-heartbeat"></i>
                    Survival Rate
                    <span class="status-indicator {{ 'status-healthy' if model_status.get('survival_rate') == 'HEALTHY' else 'status-offline' }}"></span>
                </button>
                <button class="model-btn" data-model="los" id="btn-los">
                    <i class="fas fa-calendar-day"></i>
                    Length of Stay
                    <span class="status-indicator {{ 'status-healthy' if model_status.get('los') == 'HEALTHY' else 'status-offline' }}"></span>
                </button>
                <button class="model-btn" data-model="recovery" id="btn-recovery">
                    <i class="fas fa-clock"></i>
                    Recovery Time
                    <span class="status-indicator {{ 'status-healthy' if model_status.get('recovery') == 'HEALTHY' else 'status-offline' }}"></span>
                </button>
            </div>
            <div id="selected-model-info" style="margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 5px; display: none;">
                <strong>Selected Model:</strong> <span id="selected-model-name"></span>
            </div>
        </div>

        <!-- Unified Input Form -->
        <div class="unified-form-container">
            <h3>Patient Information</h3>
            <form id="unified-prediction-form">
                
                <!-- Demographics Section -->
                <div class="form-section">
                    <h4 class="section-header">
                        <i class="fas fa-user"></i> Demographics
                    </h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="Age">Age (years) *</label>
                            <input type="number" id="Age" name="Age" min="15" max="120" value="50" required>
                        </div>
                        <div class="form-group">
                            <label for="Gender">Gender *</label>
                            <select id="Gender" name="Gender" required>
                                <option value="0">Female</option>
                                <option value="1" selected>Male</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Year_of_Diagnosis">Year of Diagnosis *</label>
                            <input type="number" id="Year_of_Diagnosis" name="Year_of_Diagnosis" min="2019" max="2025" value="2023" required>
                        </div>
                    </div>
                </div>

                <!-- Risk Factors Section -->
                <div class="form-section">
                    <h4 class="section-header">
                        <i class="fas fa-exclamation-triangle"></i> Risk Factors
                    </h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="Tobacco_Use">Tobacco Use *</label>
                            <select id="Tobacco_Use" name="Tobacco_Use" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Alcohol_Consumption">Alcohol Consumption *</label>
                            <select id="Alcohol_Consumption" name="Alcohol_Consumption" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="HPV_Infection">HPV Infection *</label>
                            <select id="HPV_Infection" name="HPV_Infection" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Betel_Quid_Use">Betel Quid Use *</label>
                            <select id="Betel_Quid_Use" name="Betel_Quid_Use" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Chronic_Sun_Exposure">Chronic Sun Exposure *</label>
                            <select id="Chronic_Sun_Exposure" name="Chronic_Sun_Exposure" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Poor_Oral_Hygiene">Poor Oral Hygiene *</label>
                            <select id="Poor_Oral_Hygiene" name="Poor_Oral_Hygiene" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Family_History_of_Cancer">Family History of Cancer *</label>
                            <select id="Family_History_of_Cancer" name="Family_History_of_Cancer" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Compromised_Immune_System">Compromised Immune System *</label>
                            <select id="Compromised_Immune_System" name="Compromised_Immune_System" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Symptoms Section -->
                <div class="form-section">
                    <h4 class="section-header">
                        <i class="fas fa-stethoscope"></i> Symptoms
                    </h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="Oral_Lesions">Oral Lesions *</label>
                            <select id="Oral_Lesions" name="Oral_Lesions" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Unexplained_Bleeding">Unexplained Bleeding *</label>
                            <select id="Unexplained_Bleeding" name="Unexplained_Bleeding" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Difficulty_Swallowing">Difficulty Swallowing *</label>
                            <select id="Difficulty_Swallowing" name="Difficulty_Swallowing" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="White_or_Red_Patches_in_Mouth">White or Red Patches in Mouth *</label>
                            <select id="White_or_Red_Patches_in_Mouth" name="White_or_Red_Patches_in_Mouth" required>
                                <option value="0" selected>No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Clinical Information Section -->
                <div class="form-section">
                    <h4 class="section-header">
                        <i class="fas fa-clipboard-check"></i> Clinical Information
                    </h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="Tumor_Size_cm">Tumor Size (cm) *</label>
                            <input type="number" id="Tumor_Size_cm" name="Tumor_Size_cm" min="0" max="10" step="0.1" value="2.0" required>
                        </div>
                        <div class="form-group">
                            <label for="Cancer_Stage">Cancer Stage (0-4) *</label>
                            <input type="number" id="Cancer_Stage" name="Cancer_Stage" min="0" max="4" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="Early_Diagnosis">Early Diagnosis *</label>
                            <select id="Early_Diagnosis" name="Early_Diagnosis" required>
                                <option value="0">No</option>
                                <option value="1" selected>Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Diet_Fruits_Vegetables_Intake">Diet (Fruits & Vegetables Intake) *</label>
                            <select id="Diet_Fruits_Vegetables_Intake" name="Diet_Fruits_Vegetables_Intake" required>
                                <option value="Low">Low</option>
                                <option value="Moderate" selected>Moderate</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Treatment Section -->
                <div class="form-section">
                    <h4 class="section-header">
                        <i class="fas fa-procedures"></i> Treatment Type
                    </h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="Treatment_Type">Treatment Type *</label>
                            <select id="Treatment_Type" name="Treatment_Type" required>
                                <option value="No Treatment">No Treatment</option>
                                <option value="Surgery" selected>Surgery</option>
                                <option value="Radiation">Radiation</option>
                                <option value="Targeted Therapy">Targeted Therapy</option>
                                <option value="Chemotherapy">Chemotherapy</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-submit-section">
                    <button type="submit" class="btn btn-primary btn-large" id="predict-btn">
                        <i class="fas fa-search"></i>
                        Get Prediction
                    </button>
                    <p class="form-help-text">Select a model above and click to get prediction</p>
                </div>
            </form>
        </div>

        <!-- Prediction Result -->
        <div id="prediction-result" class="prediction-result" style="display: none;">
            <h3>Prediction Result</h3>
            <div id="result-content"></div>
        </div>
    </div>
</div>

<div class="loading-spinner" id="loading-spinner" style="display: none;">
    <i class="fas fa-spinner fa-spin"></i>
    <p>Processing prediction...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedModel = null;
    
    // Model button handlers
    document.querySelectorAll('.model-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const model = this.dataset.model;
            
            // Check if model is offline
            const statusIndicator = this.querySelector('.status-indicator');
            if (statusIndicator && statusIndicator.classList.contains('status-offline')) {
                alert(`Model "${model}" is currently offline. Please try another model.`);
                return;
            }
            
            selectedModel = model;
            
            // Update active button
            document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update selected model info
            const modelNames = {
                'cancer_label': 'Cancer Label Detection',
                'cost': 'Treatment Cost Prediction',
                'survival_rate': 'Survival Rate Prediction',
                'los': 'Length of Stay Prediction',
                'recovery': 'Recovery Time Prediction'
            };
            
            document.getElementById('selected-model-info').style.display = 'block';
            document.getElementById('selected-model-name').textContent = modelNames[model] || model;
        });
    });

    // Form submission handler
    document.getElementById('unified-prediction-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedModel) {
            alert('Please select a prediction model first.');
            return;
        }
        
        const spinner = document.getElementById('loading-spinner');
        const resultDiv = document.getElementById('prediction-result');
        const resultContent = document.getElementById('result-content');
        
        spinner.style.display = 'flex';
        resultDiv.style.display = 'none';
        
        // Collect form data
        const formData = new FormData(this);
        const data = {};
        
        // Process all form fields
        formData.forEach((value, key) => {
            // Convert string numbers to actual numbers
            if (value === '0' || value === '1') {
                data[key] = parseInt(value);
            } else if (!isNaN(value) && value !== '') {
                data[key] = parseFloat(value);
            } else {
                data[key] = value;
            }
        });
        
        // Map form field names to backend expected names
        const fieldMapping = {
            'Tobacco_Use': 'Tobacco Use',
            'Alcohol_Consumption': 'Alcohol Consumption',
            'HPV_Infection': 'HPV Infection',
            'Betel_Quid_Use': 'Betel Quid Use',
            'Chronic_Sun_Exposure': 'Chronic Sun Exposure',
            'Poor_Oral_Hygiene': 'Poor Oral Hygiene',
            'Family_History_of_Cancer': 'Family History of Cancer',
            'Compromised_Immune_System': 'Compromised Immune System',
            'Oral_Lesions': 'Oral Lesions',
            'Unexplained_Bleeding': 'Unexplained Bleeding',
            'Difficulty_Swallowing': 'Difficulty Swallowing',
            'White_or_Red_Patches_in_Mouth': 'White or Red Patches in Mouth',
            'Tumor_Size_cm': 'Tumor Size (cm)',
            'Early_Diagnosis': 'Early Diagnosis',
            'Diet_Fruits_Vegetables_Intake': 'Diet (Fruits & Vegetables Intake)',
            'Treatment_Type': 'Treatment Type'
        };
        
        // Apply field name mapping
        const mappedData = {};
        Object.keys(data).forEach(key => {
            const mappedKey = fieldMapping[key] || key;
            mappedData[mappedKey] = data[key];
        });
        
        // Determine endpoint based on selected model
        const endpoints = {
            'cancer_label': '/api/predict/cancer_label',
            'cost': '/api/predict/cost',
            'survival_rate': '/api/predict/survival_rate',
            'los': '/api/predict/los',
            'recovery': '/api/predict/recovery'
        };
        
        try {
            const response = await fetch(endpoints[selectedModel], {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(mappedData)
            });
            
            const result = await response.json();
            
            spinner.style.display = 'none';
            resultDiv.style.display = 'block';
            
            if (result.error) {
                resultContent.innerHTML = `<div class="error-message">Error: ${result.error}</div>`;
            } else {
                let html = '<div class="result-success">';
                
                if (result.prediction_label) {
                    html += `<h4>${result.prediction_label}</h4>`;
                }
                if (result.confidence !== undefined && result.confidence !== null) {
                    html += `<p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(2)}%</p>`;
                }
                if (result.prediction_usd) {
                    html += `<h4>Predicted Cost: ${result.prediction_usd}</h4>`;
                } else if (result.prediction !== undefined) {
                    if (selectedModel === 'cost') {
                        html += `<h4>Predicted Cost: $${result.prediction.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h4>`;
                    } else if (selectedModel === 'survival_rate') {
                        html += `<h4>Predicted Survival Rate: ${result.prediction.toFixed(2)}%</h4>`;
                    } else if (selectedModel === 'los' || selectedModel === 'recovery') {
                        html += `<h4>Prediction: ${Math.round(result.prediction)} days</h4>`;
                    } else {
                        html += `<h4>Prediction: ${result.prediction}</h4>`;
                    }
                }
                
                if (result.prediction_percent) {
                    html += `<h4>Predicted Survival Rate: ${result.prediction_percent}</h4>`;
                }
                if (result.prediction_days) {
                    html += `<h4>Prediction: ${result.prediction_days}</h4>`;
                }
                
                html += '</div>';
                resultContent.innerHTML = html;
            }
        } catch (error) {
            spinner.style.display = 'none';
            resultDiv.style.display = 'block';
            resultContent.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
        }
    });
});
</script>

<style>
.form-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
}

.section-header {
    color: #667eea;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #667eea;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-header i {
    font-size: 1.2rem;
}

.unified-form-container {
    margin-top: 2rem;
}

.form-submit-section {
    text-align: center;
    margin-top: 2rem;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.btn-large {
    padding: 1rem 3rem;
    font-size: 1.1rem;
}

.form-help-text {
    margin-top: 1rem;
    color: #666;
    font-size: 0.9rem;
}
</style>
{% endblock %}
